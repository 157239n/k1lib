import json, fire, os

def export(nb:str, filename:str=None) -> None:
    """
    Exports cells in a notebook that has the "#export" tab in the first line into
    a regular python file. If `filename` is not given, will take the file name of
    the notebook. The root directory will always be that of the klib library.
    """
    answer = ["# AUTOGENERATED FILE! PLEASE DON'T EDIT"]
    lib = "/home/kelvin/repos/labs/k1lib"
    stub = f"{lib}/k1lib"
    filename = f"{stub}/{filename or nb.split('/')[-1].replace('.ipynb', '.py')}"
    print(f"Current dir: {os.system('pwd')}, {__file__}")
    print(f"File: {filename}")
    for cell in json.loads(open(f"{stub}/{nb}").read())["cells"]:
        if cell["cell_type"] != "code": continue
        source = cell["source"]
        if len(source) <= 0: continue
        if not source[0].startswith("#export"): continue
        answer.append("".join(source[1:]))
    with open(filename, 'w+') as f: f.write("\n".join(answer))
    os.system(f"{lib}/build.sh {lib}")

if __name__ == "__main__": fire.Fire(export)
